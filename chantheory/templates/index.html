<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‡çº¿ä¹–ç¦»å›æµ‹å¯è§†åŒ–</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Roboto, sans-serif; background-color: #161616; color: #ccc; }
        .controls {
            padding: 12px 20px;
            background-color: #252526;
            border-bottom: 1px solid #333;
            display: flex;
            gap: 15px;
            align-items: center;
        }
        select, button, input {
            padding: 6px 12px;
            border-radius: 4px;
            border: 1px solid #444;
            background-color: #333;
            color: #eee;
            cursor: pointer;
            font-size: 14px;
            outline: none;
        }
        button:hover { background-color: #444; }
        .btn-green { background-color: #2da44e; border: none; color: #fff; font-weight: bold; }
        #chart-container { width: 100%; height: 92vh; }
        .loading {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 16px; display: none; color: white; background: rgba(0,0,0,0.85);
            padding: 25px 50px; border-radius: 10px; z-index: 999; text-align: center;
        }
    </style>
</head>
<body>

    <div class="controls">
        <label>ä»£å¸:</label>
        <select id="symbol">
            <option value="BTC">BTC</option>
            <option value="ETH">ETH</option>
            <option value="SOL">SOL</option>
            <option value="XRP">XRP</option>
            <option value="DOGE">DOGE</option>
            <option value="BNB">BNB</option>            
        </select>

        <label>çº§åˆ«:</label>
        <select id="main_lvl">
            <option value="5m">5m</option>
            <option value="15m">15m</option>
            <option value="30m">30m</option>
            <option value="1h" selected>1h</option>
            <option value="4h">4h</option>
            <option value="1d">1d</option>
        </select>

        <label>æ•°é‡:</label>
        <input type="number" id="limit" value="1000" style="width: 70px;">

        <button class="btn-green" onclick="runBacktest()">â–¶ å¼€å§‹å›æµ‹</button>
        <span id="status" style="margin-left:auto; font-size: 13px; color: #888;">å°±ç»ª</span>
    </div>

    <div id="chart-container"></div>
    <div id="loading" class="loading">ğŸš€ æ­£åœ¨è¿›è¡Œå›æµ‹è¿ç®—...</div>

    <script>
        var myChart = echarts.init(document.getElementById('chart-container'));
        window.addEventListener('resize', () => myChart.resize());

        // EMA è®¡ç®—è¾…åŠ©å‡½æ•° (é€‚é… ECharts [open, close, low, high] æ ¼å¼)
        function calculateEMA(ohlcData, count) {
            let result = [];
            if (!ohlcData || ohlcData.length === 0) return result;
            let k = 2 / (count + 1);
            let ema = ohlcData[0][1]; // åˆå§‹ EMA å–ç¬¬ä¸€æ ¹ K çº¿çš„æ”¶ç›˜ä»·
            for (let i = 0; i < ohlcData.length; i++) {
                let close = ohlcData[i][1];
                ema = (close - ema) * k + ema;
                result.push(parseFloat(ema.toFixed(6)));
            }
            return result;
        }

        function runBacktest() {
            const symbol = document.getElementById('symbol').value;
            const main_lvl = document.getElementById('main_lvl').value;
            const limit = document.getElementById('limit').value;
            const loading = document.getElementById('loading');
            const statusSpan = document.getElementById('status');

            loading.style.display = 'block';
            statusSpan.innerText = `æ­£åœ¨å›æµ‹ ${symbol}...`;

            fetch(`/run_backtest?symbol=${symbol}&main_lvl=${main_lvl}&sub_lvl=15m&limit=${limit}`)
                .then(res => res.json())
                .then(res => {
                    loading.style.display = 'none';
                    if (res.status === 'success') {
                        statusSpan.innerText = `å›æµ‹å®Œæˆ: ${symbol} (ä¹°:${res.data.buys.length} å–:${res.data.sells.length})`;
                        renderChart(res.data, symbol, main_lvl);
                    }
                });
        }

        function renderChart(data, symbol, interval) {
            const dates = data.dates;
            const ohlc = data.ohlc;

            // è®¡ç®—å››æ¡ EMA
            const ema7 = calculateEMA(ohlc, 7);
            const ema25 = calculateEMA(ohlc, 25);
            const ema99 = calculateEMA(ohlc, 99);
            const ema255 = calculateEMA(ohlc, 255);

            const markPoints = [];
            data.buys.forEach(b => {
                markPoints.push({
                    coord: [b[0], b[1]], name: b[2], value: b[1],
                    itemStyle: { color: '#2ecc71' }, symbol: 'arrow', symbolSize: 12,symbolOffset: [0, 10],
                    label: { show: true, position: 'bottom', formatter: '{b}', fontWeight: 'bold' }
                });
            });
            data.sells.forEach(s => {
                markPoints.push({
                    coord: [s[0], s[1]], name: s[2], value: s[1],
                    itemStyle: { color: '#e74c3c' }, symbol: 'arrow', symbolSize: 12,symbolRotate: 180, symbolOffset: [0, -10],
                    label: { show: true, position: 'top', formatter: '{b}', fontWeight: 'bold' }
                });
            });

            const option = {
                backgroundColor: '#161616',
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'cross' },
                    formatter: function (params) {
                        let html = `<div style="border-bottom:1px solid #555;padding-bottom:3px;">${params[0].name}</div>`;
                        params.forEach(p => {
                            if (p.seriesName === 'KLine') {
                                // ä¿®æ­£ K çº¿æ˜¾ç¤ºé¡ºåºï¼šå¼€(1) æ”¶(2) ä½(3) é«˜(4)
                                html += `å¼€:${p.data[1]} <b>æ”¶:${p.data[2]}</b> ä½:${p.data[3]} é«˜:${p.data[4]}<br/>`;
                            } else if (p.value !== undefined) {
                                // EMA æ˜¾ç¤ºä¿ç•™ 4-6 ä½å°æ•°
                                html += `<span style="color:${p.color}">â—</span> ${p.seriesName}: ${parseFloat(p.value).toFixed(4)}<br/>`;
                            }
                        });
                        return html;
                    }
                },
                grid: [{ left: '50px', right: '30px', top: '5%', height: '70%' }, { left: '50px', right: '30px', top: '80%', height: '15%' }],
                xAxis: [{ type: 'category', data: dates, gridIndex: 0 }, { type: 'category', data: dates, gridIndex: 1 }],
                yAxis: [{ scale: true, gridIndex: 0 }, { scale: true, gridIndex: 1, splitLine: {show: false} }],
                dataZoom: [{ type: 'inside', xAxisIndex: [0, 1], start: 90, end: 100 }, { type: 'slider', xAxisIndex: [0, 1], bottom: 10 }],
                series: [
                    {
                        name: 'KLine', type: 'candlestick', data: ohlc,
                        itemStyle: { color: '#20b2aa', color0: '#ff6347', borderColor: '#20b2aa', borderColor0: '#ff6347' },
                        markPoint: { data: markPoints }
                    },
                    { name: 'EMA7', type: 'line', data: ema7, showSymbol: false, lineStyle: { color: '#FFD700', width: 1 } },
                    { name: 'EMA25', type: 'line', data: ema25, showSymbol: false, lineStyle: { color: '#9370DB', width: 1 } },
                    { name: 'EMA99', type: 'line', data: ema99, showSymbol: false, lineStyle: { color: '#1E90FF', width: 2 } },
                    { name: 'EMA255', type: 'line', data: ema255, showSymbol: false, lineStyle: { color: '#00FF00', width: 2 } },
                    {
                        name: 'Volume', type: 'bar', xAxisIndex: 1, yAxisIndex: 1, data: data.volume,
                        itemStyle: { color: (params) => ohlc[params.dataIndex][1] >= ohlc[params.dataIndex][0] ? '#20b2aa' : '#ff6347' }
                    }
                ]
            };
            myChart.setOption(option, true);
        }
    </script>
</body>
</html>