<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Áº†ËÆ∫ÁúüÂÆûÂõûÊµãÂèØËßÜÂåñ</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Roboto, sans-serif; background-color: #161616; color: #ccc; }
        .controls {
            padding: 12px 20px;
            background-color: #252526;
            border-bottom: 1px solid #333;
            display: flex;
            gap: 15px;
            align-items: center;
        }
        select, button, input {
            padding: 6px 12px;
            border-radius: 4px;
            border: 1px solid #444;
            background-color: #333;
            color: #eee;
            cursor: pointer;
            font-size: 14px;
            outline: none;
        }
        button:hover { background-color: #444; }
        input:focus, select:focus { border-color: #007acc; }
        .btn-green { background-color: #2da44e; border: none; color: #fff; font-weight: bold; }
        .btn-green:hover { background-color: #2c974b; }
        
        #chart-container { width: 100%; height: 92vh; }
        
        .loading {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 16px; display: none; color: white; background: rgba(0,0,0,0.85);
            padding: 25px 50px; border-radius: 10px; z-index: 999; text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>

    <div class="controls">
        <label>‰ª£Â∏Å:</label>
        <select id="symbol">
            <option value="BTC">BTC</option>
            <option value="ETH">ETH</option>
            <option value="SOL">SOL</option>
            <option value="XRP">XRP</option>
            <option value="DOGE">DOGE</option>
            <option value="BNB">BNB</option>
        </select>

        <label>‰∏ªÁ∫ßÂà´:</label>
        <select id="main_lvl">
            <option value="30m">30m</option>
            <option value="1h" selected>1h</option>
            <option value="4h">4h</option>
            <option value="1d">1d</option>
        </select>

        <label>Ê¨°Á∫ßÂà´:</label>
        <select id="sub_lvl">
            <option value="5m">5m</option>
            <option value="15m" selected>15m</option>
            <option value="30m">30m</option>
            <option value="4h">4h</option>
        </select>

        <label>Êï∞Èáè:</label>
        <input type="number" id="limit" value="1000" style="width: 70px;">

        <button class="btn-green" onclick="runBacktest()">‚ñ∂ ÂºÄÂßãÂõûÊµã</button>
        <span id="status" style="margin-left:auto; font-size: 13px; color: #888;">Â∞±Áª™</span>
    </div>

    <div id="chart-container"></div>
    <div id="loading" class="loading">
        <div>üöÄ Ê≠£Âú®ËøõË°åÂõûÊµãËøêÁÆó...</div>
        <div style="font-size:12px; color:#aaa; margin-top:8px;">(ÈÄêÊ†πKÁ∫øÊ®°ÊãüÊâ´Êèè‰∏≠ÔºåËØ∑Á®çÂÄô)</div>
    </div>

    <script>
        var myChart = echarts.init(document.getElementById('chart-container'));
        
        window.addEventListener('resize', () => myChart.resize());

        // È°µÈù¢Âä†ËΩΩÊó∂Ëá™Âä®ËøêË°å‰∏ÄÊ¨°
        // runBacktest(); 

        function runBacktest() {
            const symbol = document.getElementById('symbol').value;
            const main_lvl = document.getElementById('main_lvl').value;
            const sub_lvl = document.getElementById('sub_lvl').value;
            const limit = document.getElementById('limit').value;
            const loading = document.getElementById('loading');
            const statusSpan = document.getElementById('status');

            loading.style.display = 'block';
            statusSpan.innerText = `Ê≠£Âú®ÂõûÊµã ${symbol}...`;

            fetch(`/run_backtest?symbol=${symbol}&main_lvl=${main_lvl}&sub_lvl=${sub_lvl}&limit=${limit}`)
                .then(res => res.json())
                .then(res => {
                    loading.style.display = 'none';
                    if (res.status === 'success') {
                        const d = res.data;
                        statusSpan.innerText = `ÂõûÊµãÂÆåÊàê: ${symbol} ${main_lvl} (‰π∞ÁÇπ:${d.buys.length} ÂçñÁÇπ:${d.sells.length})`;
                        renderChart(d, symbol, main_lvl);
                    } else {
                        statusSpan.innerText = 'ÈîôËØØ: ' + res.message;
                        alert(res.message);
                    }
                })
                .catch(err => {
                    loading.style.display = 'none';
                    statusSpan.innerText = 'ËøûÊé•Â§±Ë¥•';
                    console.error(err);
                    alert('ËøûÊé•Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü• Python ÊúçÂä°ÊòØÂê¶ÂêØÂä®');
                });
        }

        function renderChart(data, symbol, interval) {
            const dates = data.dates;
            
            // --- ÂÖ≥ÈîÆ‰øÆÊîπÔºö‰øÆÂ§ç‰π∞ÂçñÁÇπÊ†áÁ≠æÊòæÁ§∫ ---
            // ÂêéÁ´ØÊï∞ÊçÆÊ†ºÂºè: [Time, Price, Type, Desc]
            // ECharts markPoint ÈúÄË¶Å name Â±ûÊÄßÊù•ÊòæÁ§∫ label
            
            const markPoints = [];
            data.buys.forEach(b => {
                markPoints.push({
                    coord: [b[0], b[1]], 
                    name: b[2], // Â∞Ü Type (Â¶Ç 1B) ÊîæÂÖ• name
                    value: b[1], 
                    itemStyle: { color: '#2ecc71' }, 
                    symbol: 'arrow', symbolRotate: 0, symbolOffset: [0, 10], symbolSize: 12,
                    label: { 
                        show: true, position: 'bottom', 
                        formatter: '{b}', // {b} ‰ª£Ë°® nameÔºåÂç≥ÊòæÁ§∫ 1B/2B/3B
                        fontWeight: 'bold', color: '#2ecc71', fontSize: 11 
                    },
                    tooltip: { formatter: `Êó∂Èó¥: ${b[0]}<br>Á±ªÂûã: ${b[2]}<br>ËØ¥Êòé: ${b[3]}` }
                });
            });
            data.sells.forEach(s => {
                markPoints.push({
                    coord: [s[0], s[1]], 
                    name: s[2], // Â∞Ü Type (Â¶Ç 2S) ÊîæÂÖ• name
                    value: s[1],
                    itemStyle: { color: '#e74c3c' }, 
                    symbol: 'arrow', symbolRotate: 180, symbolOffset: [0, -10], symbolSize: 12,
                    label: { 
                        show: true, position: 'top', 
                        formatter: '{b}', // ÊòæÁ§∫ 1S/2S
                        fontWeight: 'bold', color: '#e74c3c', fontSize: 11
                    },
                    tooltip: { formatter: `Êó∂Èó¥: ${s[0]}<br>Á±ªÂûã: ${s[2]}<br>ËØ¥Êòé: ${s[3]}` }
                });
            });

            // Ê∂®Ë∑åÈ¢úËâ≤Âà§Êñ≠
            const volColors = data.ohlc.map((item) => {
                return item[1] >= item[0] ? '#20b2aa' : '#ff6347';
            });

            const option = {
                backgroundColor: '#161616',
                animation: false,
                title: { text: `Áº†ËÆ∫Á≠ñÁï•ÂõûÊµã: ${symbol} - ${interval}`, left: 'center', textStyle: { color: '#eee', fontSize: 16 } },
                
                // --- ÂÖ≥ÈîÆ‰øÆÊîπÔºö‰∏ì‰∏öÁ∫ß Tooltip ---
                tooltip: { 
                    trigger: 'axis', 
                    axisPointer: { type: 'cross', label: { backgroundColor: '#6a7985' } }, 
                    backgroundColor: 'rgba(30,30,30,0.9)', 
                    borderColor: '#444',
                    borderWidth: 1,
                    textStyle: { color: '#eee', fontSize: 13 },
                    formatter: function (params) {
                        if (!params || params.length === 0) return '';
                        
                        let date = params[0].name;
                        let html = `<div style="font-weight:bold; margin-bottom:5px; border-bottom:1px solid #555; padding-bottom:3px;">${date}</div>`;
                        
                        // ÂØªÊâæÂØπÂ∫îÁöÑÊï∞ÊçÆ
                        let kline = params.find(p => p.seriesName === 'KLine');
                        let ma60 = params.find(p => p.seriesName === 'MA60');
                        let vol = params.find(p => p.seriesName === 'Volume');
                        let rsi = params.find(p => p.seriesName === 'RSI');
                        let macdBar = params.find(p => p.seriesName === 'MACD');
                        let dif = params.find(p => p.seriesName === 'DIF');
                        let dea = params.find(p => p.seriesName === 'DEA');

                        if (kline) {
                            // ECharts Candlestick data index: [index, open, close, low, high]
                            let o = kline.data[1], c = kline.data[2], l = kline.data[3], h = kline.data[4];
                            let clr = c >= o ? '#20b2aa' : '#ff6347'; // Ê∂®ÁªøË∑åÁ∫¢
                            html += `<div style="color:${clr}">‚óè Open: ${o}</div>`;
                            html += `<div style="color:${clr}">‚óè High: ${h}</div>`;
                            html += `<div style="color:${clr}">‚óè Low:  ${l}</div>`;
                            html += `<div style="color:${clr}">‚óè Close:${c}</div>`;
                        }
                        
                        if (ma60) html += `<div style="color:#f39c12">MA60: ${ma60.value.toFixed(2)}</div>`;
                        if (vol) html += `<div style="color:#aaa">Vol: ${Math.round(vol.value)}</div>`;
                        if (rsi) html += `<div style="color:#d35400">RSI: ${rsi.value.toFixed(2)}</div>`;
                        
                        if (macdBar) {
                            let mClr = macdBar.value > 0 ? '#ff6347' : '#20b2aa';
                            html += `<br><div>MACD: <span style="color:${mClr}">${macdBar.value.toFixed(4)}</span></div>`;
                            if (dif) html += `<div>DIF: ${dif.value.toFixed(4)}</div>`;
                            if (dea) html += `<div>DEA: ${dea.value.toFixed(4)}</div>`;
                        }
                        
                        return html;
                    }
                },
                
                axisPointer: { link: { xAxisIndex: 'all' } },

                grid: [
                    { left: '60px', right: '30px', top: '5%', height: '55%' },   // KÁ∫ø
                    { left: '60px', right: '30px', top: '63%', height: '10%' },  // Volume
                    { left: '60px', right: '30px', top: '76%', height: '10%' },  // MACD
                    { left: '60px', right: '30px', top: '89%', height: '8%' }    // RSI
                ],

                // --- ÂÖ≥ÈîÆ‰øÆÊîπÔºöÊó∂Èó¥ÂàªÂ∫¶È¢úËâ≤Âèò‰∫Æ ---
                xAxis: [
                    { 
                        type: 'category', data: dates, gridIndex: 0, 
                        axisLine: { lineStyle: { color: '#555' } }, 
                        axisLabel: { show: false } // ‰∏ªÂõæ‰∏çÊòæÁ§∫Êó∂Èó¥ÔºåÂ§™Êå§
                    },
                    { type: 'category', data: dates, gridIndex: 1, axisLine: { show: false }, axisLabel: { show: false } },
                    { type: 'category', data: dates, gridIndex: 2, axisLine: { show: false }, axisLabel: { show: false } },
                    { 
                        type: 'category', data: dates, gridIndex: 3, 
                        axisLine: { lineStyle: { color: '#555' } },
                        axisLabel: { color: '#e0e0e0', fontSize: 11 } // ÊúÄÂ∫ïÈÉ®Êó∂Èó¥ËΩ¥Ôºå‰∫ÆÁôΩËâ≤
                    }
                ],

                yAxis: [
                    { scale: true, gridIndex: 0, splitLine: { show: true, lineStyle: { color: '#333' } }, axisLine: { show: false }, axisLabel: { color: '#aaa' } },
                    { scale: true, gridIndex: 1, splitLine: { show: false }, axisLabel: { show: false }, axisLine: { show: false } },
                    { scale: true, gridIndex: 2, splitLine: { show: true, lineStyle: { color: '#333', type: 'dashed' } }, axisLabel: { color: '#777', fontSize: 10 } },
                    { scale: true, gridIndex: 3, splitLine: { show: true, lineStyle: { color: '#333', type: 'dashed' } }, axisLabel: { color: '#777', fontSize: 10 }, min: 0, max: 100 }
                ],

                dataZoom: [
                    { type: 'inside', xAxisIndex: [0, 1, 2, 3], start: 80, end: 100 },
                    { type: 'slider', xAxisIndex: [0, 1, 2, 3], bottom: 0, height: 15, borderColor: '#333', fillerColor: 'rgba(255,255,255,0.1)', textStyle: {color: '#aaa'} }
                ],

                series: [
                    // --- Grid 0 ---
                    {
                        name: 'KLine', type: 'candlestick', xAxisIndex: 0, yAxisIndex: 0, data: data.ohlc,
                        itemStyle: { 
                            color: '#20b2aa', color0: '#ff6347', 
                            borderColor: '#20b2aa', borderColor0: '#ff6347' 
                        },
                        markPoint: { data: markPoints }
                    },
                    {
                        name: 'MA60', type: 'line', xAxisIndex: 0, yAxisIndex: 0, data: data.ma60,
                        smooth: true, showSymbol: false, lineStyle: { color: '#f39c12', width: 2, opacity: 0.8 }
                    },

                    // --- Grid 1 ---
                    {
                        name: 'Volume', type: 'bar', xAxisIndex: 1, yAxisIndex: 1, data: data.volume,
                        itemStyle: { color: (params) => volColors[params.dataIndex] }
                    },

                    // --- Grid 2 ---
                    {
                        name: 'MACD', type: 'bar', xAxisIndex: 2, yAxisIndex: 2, data: data.macd.bar,
                        itemStyle: { color: (params) => params.value > 0 ? '#ff6347' : '#20b2aa' }
                    },
                    {
                        name: 'DIF', type: 'line', xAxisIndex: 2, yAxisIndex: 2, data: data.macd.diff,
                        showSymbol: false, lineStyle: { color: '#fff', width: 1 }
                    },
                    {
                        name: 'DEA', type: 'line', xAxisIndex: 2, yAxisIndex: 2, data: data.macd.dea,
                        showSymbol: false, lineStyle: { color: '#ffff00', width: 1 }
                    },

                    // --- Grid 3 ---
                    {
                        name: 'RSI', type: 'line', xAxisIndex: 3, yAxisIndex: 3, data: data.rsi,
                        showSymbol: false, lineStyle: { color: '#d35400', width: 1.5 },
                        markLine: {
                            symbol: 'none',
                            data: [
                                { yAxis: 70, lineStyle: { color: '#ff6347', type: 'dashed' } },
                                { yAxis: 30, lineStyle: { color: '#20b2aa', type: 'dashed' } }
                            ],
                            label: { show: false }
                        }
                    }
                ]
            };
            
            myChart.setOption(option, true);
        }
    </script>
</body>
</html>