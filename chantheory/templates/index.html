<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¼ è®ºçœŸå®å›æµ‹å¯è§†åŒ–</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; background-color: #1e1e1e; color: #ccc; }
        .controls {
            padding: 10px 20px;
            background-color: #2d2d2d;
            border-bottom: 1px solid #444;
            display: flex;
            gap: 15px;
            align-items: center;
        }
        select, button, input {
            padding: 5px 10px;
            border-radius: 4px;
            border: 1px solid #555;
            background-color: #333;
            color: white;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover { background-color: #444; }
        .btn-green { background-color: #2ecc71; border-color: #27ae60; color: #fff; }
        .btn-green:hover { background-color: #27ae60; }
        #chart-container { width: 100%; height: 90vh; }
        .loading {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 16px; display: none; color: white; background: rgba(0,0,0,0.8);
            padding: 20px 40px; border-radius: 8px; z-index: 999; text-align: center;
        }
    </style>
</head>
<body>

    <div class="controls">
        <label>ä»£å¸:</label>
        <select id="symbol">
            <option value="BTC">BTC</option>
            <option value="ETH">ETH</option>
            <option value="SOL">SOL</option>
            <option value="XRP">XRP</option>
            <option value="DOGE">DOGE</option>
            <option value="BNB">BNB</option>
        </select>

        <label>ä¸»çº§åˆ«:</label>
        <select id="main_lvl">
            <option value="30m">30m</option>
            <option value="1h" selected>1h</option>
            <option value="4h">4h</option>
            <option value="1d">1d</option>
        </select>

        <label>æ¬¡çº§åˆ«:</label>
        <select id="sub_lvl">
            <option value="5m">5m</option>
            <option value="15m" selected>15m</option>
            <option value="1h">1h</option>
            <option value="4h">4h</option>
        </select>

        <label>å›æµ‹æ•°é‡:</label>
        <input type="number" id="limit" value="1000" style="width: 60px;">

        <button class="btn-green" onclick="runBacktest()">â–¶ å¼€å§‹å›æµ‹</button>
        <span id="status" style="margin-left:auto; font-size: 12px; color: #888;">å°±ç»ª</span>
    </div>

    <div id="chart-container"></div>
    <div id="loading" class="loading">
        <div>ğŸš€ æ­£åœ¨è¿›è¡ŒçœŸå®å›æµ‹...</div>
        <div style="font-size:12px; color:#aaa; margin-top:5px;">(æ¨¡æ‹Ÿé€Kçº¿æ‰«æï¼Œè¯·ç¨å€™)</div>
    </div>

    <script>
        var myChart = echarts.init(document.getElementById('chart-container'));
        
        window.addEventListener('resize', () => myChart.resize());

        function runBacktest() {
            const symbol = document.getElementById('symbol').value;
            const main_lvl = document.getElementById('main_lvl').value;
            const sub_lvl = document.getElementById('sub_lvl').value;
            const limit = document.getElementById('limit').value;
            const loading = document.getElementById('loading');
            const statusSpan = document.getElementById('status');

            loading.style.display = 'block';
            statusSpan.innerText = `æ­£åœ¨å›æµ‹ ${symbol}...`;

            // è°ƒç”¨æ–°çš„å›æµ‹æ¥å£
            fetch(`http://localhost:5000/run_backtest?symbol=${symbol}&main_lvl=${main_lvl}&sub_lvl=${sub_lvl}&limit=${limit}`)
                .then(res => res.json())
                .then(res => {
                    loading.style.display = 'none';
                    if (res.status === 'success') {
                        const d = res.data;
                        statusSpan.innerText = `å›æµ‹å®Œæˆ: ${symbol} ${main_lvl} (ä¹°ç‚¹:${d.buys.length} å–ç‚¹:${d.sells.length})`;
                        renderChart(d, symbol, main_lvl);
                    } else {
                        statusSpan.innerText = 'é”™è¯¯: ' + res.message;
                        alert(res.message);
                    }
                })
                .catch(err => {
                    loading.style.display = 'none';
                    statusSpan.innerText = 'è¿æ¥å¤±è´¥';
                    console.error(err);
                    alert('è¯·ç¡®ä¿ server_backtest.py å·²å¯åŠ¨');
                });
        }

function renderChart(data, symbol, interval) {
            const dates = data.dates;
            
            // æ„é€ ä¹°å–ç‚¹æ ‡è®° (ä¿æŒä¸å˜)
            const markPoints = [];
            data.buys.forEach(b => {
                markPoints.push({
                    coord: [b[0], b[1]], value: b[2], itemStyle: { color: '#2ecc71' }, 
                    symbol: 'arrow', symbolRotate: 0, symbolOffset: [0, 10], symbolSize: 15,
                    label: { position: 'bottom', formatter: '{b}', fontWeight: 'bold' },
                    tooltip: { formatter: b[3] }
                });
            });
            data.sells.forEach(s => {
                markPoints.push({
                    coord: [s[0], s[1]], value: s[2], itemStyle: { color: '#e74c3c' }, 
                    symbol: 'arrow', symbolRotate: 180, symbolOffset: [0, -10], symbolSize: 15,
                    label: { position: 'top', formatter: '{b}', fontWeight: 'bold' },
                    tooltip: { formatter: s[3] }
                });
            });

            // åˆ¤æ–­æˆäº¤é‡é¢œè‰²çš„è¾…åŠ©å‡½æ•° (æ¶¨çº¢è·Œç»¿ æˆ– æ¶¨ç»¿è·Œçº¢)
            // æ—¢ç„¶æˆ‘ä»¬è¦ç»¿æ¶¨çº¢è·Œ:
            // å¦‚æœ æ”¶ç›˜ > å¼€ç›˜ (æ¶¨) -> ç»¿è‰² #14b143
            // å¦‚æœ æ”¶ç›˜ < å¼€ç›˜ (è·Œ) -> çº¢è‰² #ef232a
            const volColors = data.ohlc.map((item) => {
                return item[1] >= item[0] ? '#14b143' : '#ef232a';
            });

            const option = {
                backgroundColor: '#1e1e1e',
                animation: false,
                title: { text: `çœŸå®å›æµ‹: ${symbol} - ${interval}`, left: 'center', textStyle: { color: '#fff' } },
                
                // æç¤ºæ¡†ï¼šæ‰€æœ‰åæ ‡è½´åŒæ­¥æ˜¾ç¤º
                tooltip: { 
                    trigger: 'axis', 
                    axisPointer: { type: 'cross' }, 
                    backgroundColor: 'rgba(50,50,50,0.9)', 
                    textStyle: { color: '#fff' },
                    formatter: function (params) {
                        // è‡ªå®šä¹‰ Tooltip æ˜¾ç¤ºé€»è¾‘ï¼Œé˜²æ­¢å¤ªé•¿é®æŒ¡
                        let res = params[0].name + '<br/>';
                        params.forEach(param => {
                            if(param.seriesName === 'KLine') return; // Kçº¿æ•°æ®å¤ªé•¿ä¸æ˜¾ç¤º
                            if(param.value !== undefined) {
                                let val = param.value;
                                if(typeof val === 'number') val = val.toFixed(2);
                                res += `${param.marker} ${param.seriesName}: ${val}<br/>`;
                            }
                        });
                        return res;
                    }
                },
                
                // åæ ‡è½´æŒ‡é’ˆé“¾æ¥ï¼šè®©4ä¸ªå›¾çš„å…‰æ ‡åŒæ­¥
                axisPointer: { link: { xAxisIndex: 'all' } },

                // å¸ƒå±€ç½‘æ ¼ï¼šå®šä¹‰4ä¸ªåŒºåŸŸ (Top, Height)
                grid: [
                    { left: '5%', right: '5%', top: '5%', height: '45%' },   // 0. ä¸»å›¾ Kçº¿ (å æ¯”æœ€å¤§)
                    { left: '5%', right: '5%', top: '53%', height: '10%' },  // 1. æˆäº¤é‡
                    { left: '5%', right: '5%', top: '66%', height: '12%' },  // 2. MACD
                    { left: '5%', right: '5%', top: '81%', height: '12%' }   // 3. RSI
                ],

                // Xè½´é…ç½®ï¼š4ä¸ªXè½´ï¼Œå…¨éƒ¨å…±äº« data.datesï¼Œéšè—é™¤äº†æœ€åä¸€ä¸ªä¹‹å¤–çš„æ ‡ç­¾
                xAxis: [
                    { type: 'category', data: dates, gridIndex: 0, axisLine: { show: false }, axisLabel: { show: false } },
                    { type: 'category', data: dates, gridIndex: 1, axisLine: { show: false }, axisLabel: { show: false } },
                    { type: 'category', data: dates, gridIndex: 2, axisLine: { show: false }, axisLabel: { show: false } },
                    { type: 'category', data: dates, gridIndex: 3, axisLine: { lineStyle: { color: '#555' } } } // æœ€åº•ä¸‹çš„æ˜¾ç¤ºæ ‡ç­¾
                ],

                // Yè½´é…ç½®ï¼š4ä¸ªYè½´ï¼Œåˆ†åˆ«å¯¹åº”4ä¸ªGrid
                yAxis: [
                    { scale: true, gridIndex: 0, splitLine: { show: true, lineStyle: { color: '#333' } }, axisLine: { show: false }, axisLabel: { color: '#999' } },
                    { scale: true, gridIndex: 1, splitLine: { show: false }, axisLabel: { show: false }, axisLine: { show: false } }, // Volume Yè½´ä¸æ˜¾ç¤ºæ ‡ç­¾
                    { scale: true, gridIndex: 2, splitLine: { show: true, lineStyle: { color: '#333', type: 'dashed' } }, axisLabel: { color: '#999', fontSize: 10 } },
                    { scale: true, gridIndex: 3, splitLine: { show: true, lineStyle: { color: '#333', type: 'dashed' } }, axisLabel: { color: '#999', fontSize: 10 }, min: 0, max: 100 }
                ],

                // ç¼©æ”¾æ§ä»¶ï¼šæ§åˆ¶æ‰€æœ‰Xè½´
                dataZoom: [
                    { type: 'inside', xAxisIndex: [0, 1, 2, 3], start: 70, end: 100 },
                    { type: 'slider', xAxisIndex: [0, 1, 2, 3], bottom: 0, height: 20, borderColor: '#333', fillerColor: 'rgba(255,255,255,0.1)' }
                ],

                // æ•°æ®ç³»åˆ—
                series: [
                    // --- Grid 0: Kçº¿ + MA60 ---
                    {
                        name: 'KLine', type: 'candlestick', xAxisIndex: 0, yAxisIndex: 0, data: data.ohlc,
                        itemStyle: { 
                            color: '#14b143', color0: '#ef232a', 
                            borderColor: '#14b143', borderColor0: '#ef232a' 
                        },
                        markPoint: { data: markPoints }
                    },
                    {
                        name: 'MA60', type: 'line', xAxisIndex: 0, yAxisIndex: 0, data: data.ma60,
                        smooth: true, showSymbol: false, lineStyle: { color: '#f39c12', width: 2 }
                    },

                    // --- Grid 1: Volume ---
                    {
                        name: 'Volume', type: 'bar', xAxisIndex: 1, yAxisIndex: 1, data: data.volume,
                        itemStyle: {
                            color: (params) => { return volColors[params.dataIndex]; }
                        }
                    },

                    // --- Grid 2: MACD ---
                    {
                        name: 'MACD', type: 'bar', xAxisIndex: 2, yAxisIndex: 2, data: data.macd.bar,
                        itemStyle: {
                            color: (params) => { return params.value > 0 ? '#14b143' : '#ef232a'; }
                        }
                    },
                    {
                        name: 'DIF', type: 'line', xAxisIndex: 2, yAxisIndex: 2, data: data.macd.diff,
                        showSymbol: false, lineStyle: { color: '#fff', width: 1 }
                    },
                    {
                        name: 'DEA', type: 'line', xAxisIndex: 2, yAxisIndex: 2, data: data.macd.dea,
                        showSymbol: false, lineStyle: { color: '#ffff00', width: 1 }
                    },

                    // --- Grid 3: RSI ---
                    {
                        name: 'RSI', type: 'line', xAxisIndex: 3, yAxisIndex: 3, data: data.rsi,
                        showSymbol: false, lineStyle: { color: '#d35400', width: 1.5 },
                        markLine: {
                            symbol: 'none',
                            data: [
                                { yAxis: 70, lineStyle: { color: '#ef232a', type: 'dashed' } }, // è¶…ä¹°çº¿
                                { yAxis: 30, lineStyle: { color: '#14b143', type: 'dashed' } }  // è¶…å–çº¿
                            ],
                            label: { show: false }
                        }
                    }
                ]
            };
            
            myChart.setOption(option, true);
        }
    </script>
</body>
</html>